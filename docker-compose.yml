services:
  caddy:
    image: caddy:latest
    restart: always
    ports:
      - "80:80"
      - "443:443"
    volumes:
      - ./Caddyfile:/etc/caddy/Caddyfile
      - caddy_data:/data
      - caddy_config:/config
      - static:/srv/static:ro
      - media:/srv/media:ro
    depends_on:
      - frontend
      - backend

  backend:
    build:
      context: ./backend
    env_file:
      - .env.production   # ✅ берём продакшен-настройки
    environment:
      - MODE=production   # ✅ Django всегда грузит .env.production
    command: gunicorn core.wsgi:application -b 0.0.0.0:8000 --workers 3 --threads 2 --timeout 60
    volumes:
      - static:/app/staticfiles
      - media:/app/media
    depends_on:
      - redis
    restart: unless-stopped

  redis:
    image: redis:7-alpine
    restart: unless-stopped

  frontend:
    build:
      context: ./frontend/client-app
      dockerfile: Dockerfile
      args:
        VITE_API_BASE: /api
    # ports:
    #   - "80:80"    # ❌ не нужно, Caddy слушает порт 80
    env_file:
      - .env.production   # ✅ можно указывать тот же (если нужны API_URL и т.п.)
    environment:
      - MODE=production   # ✅ чтобы сборка шла в правильном режиме
    volumes:
      - static:/srv/static:ro
      - media:/srv/media:ro
    depends_on:
      - backend
    restart: unless-stopped

  trading-bots:
    build:
      context: ./SERVER_PACK
    container_name: crm-legalflow_bots
    restart: always
    # Храним исходники на хосте, а node_modules — внутри контейнера
    volumes:
      - ./SERVER_PACK:/app
      - /app/node_modules
    # Команда по умолчанию определяется в Dockerfile (START_ALL_BOTS.js)
    depends_on:
      - backend

volumes:
  static:
  media:
  caddy_data: {}
  caddy_config: {}
